<!DOCTYPE html>
<html>

<head>
  <title>Geoid</title>
  <style type="text/css">
    html,
    body {
      height: 100vh;
      width: 100vw;
      padding: 0;
      margin: 0;
      position: relative;
    }
    #map {
      width: 100vw;
      height: 100vh;
    }
    #hover-stats {
      position: absolute;
      top: 0;
      left: 0;
      background-color: #fff;
      padding: 4px 10px;
    }
  </style>
</head>

<body>
  <div id="map"
    data-gesture-handling="off"
    data-lat="35.3528"
    data-lng="138.7807"
    data-zoom="10"
    data-marker="off"
    data-style="./geoid-style.json"
    data-hash="on"
  ></div>
  <div id="hover-stats">
    <div id="current-pos"></div>
    <div id="current-alt"></div>
  </div>
  <div id="cross-section">
    <canvas id="cross-section-chart"></canvas>
  </div>

  <script type="text/javascript" src="https://cdn.geolonia.com/v1/embed?geolonia-api-key=YOUR-API-KEY"></script>
  <!-- <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script> -->
  <script type="module">
    import tilebelt from "./tilebelt.js";

    const map = new geolonia.Map('#map');
    window._mainMap = map;
    let hoveredStateId = null;
    const currentPos = document.getElementById('current-pos'),
          currentAlt = document.getElementById('current-alt');
    map.on('load', function () {
      const mapEl = document.getElementById('map');
      let hovered = [];
      mapEl.addEventListener('mousemove', function(e) {
        e.point = new mapboxgl.Point(e.clientX, e.clientY);
        const features = map.queryRenderedFeatures(e.point, {layers: ['geoid-tiles']});
        for (const feature of hovered) {
          map.setFeatureState(feature, {
            'hover': false,
          });
        }

        const seen = {};
        hovered = features;
        let i = 0;
        for (const feature of hovered) {
          if (seen[feature.id]) continue;

          seen[feature.id] = true;
          map.setFeatureState(feature, {
            'hover': i === 0,
          });
          i++;
        }

        const currentFeature = features[0];
        if (currentFeature) {
          console.log(currentFeature.properties);
          const props = currentFeature.properties;
          currentPos.innerText = `${props.z}/0/${props.x}/${props.y}`;
          currentAlt.innerText = `${(props.geoid_height / 1000).toFixed(3)}m`;
        }
      });
    });
  </script>
</body>

</html>
